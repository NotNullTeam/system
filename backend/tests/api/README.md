# API å“åº”æµ‹è¯•æ–‡æ¡£

## æ¦‚è¿°

æœ¬ç›®å½•åŒ…å«äº†å®Œæ•´çš„APIå“åº”æµ‹è¯•å¥—ä»¶ï¼Œç”¨äºéªŒè¯IPæ™ºæ…§è§£ç­”ä¸“å®¶ç³»ç»Ÿçš„æ‰€æœ‰APIç«¯ç‚¹çš„å“åº”æ ¼å¼ã€çŠ¶æ€ç å’Œæ•°æ®ç»“æ„çš„æ­£ç¡®æ€§ã€‚

**æµ‹è¯•è§„æ¨¡**ï¼š116ä¸ªç²¾å¿ƒè®¾è®¡çš„æµ‹è¯•ç”¨ä¾‹ï¼Œè¦†ç›–5ä¸ªæ ¸å¿ƒAPIæ¨¡å—ã€å“åº”ä¸€è‡´æ€§éªŒè¯å’Œé™„ä»¶è¿‡æ»¤åŠŸèƒ½ã€‚

## ğŸ—‚ï¸ ç›®å½•ç»“æ„

```
tests/api/
â”œâ”€â”€ conftest.py                          # pytesté…ç½®å’Œfixtures
â”œâ”€â”€ v1/                                  # API v1ç‰ˆæœ¬æµ‹è¯•
â”‚   â”œâ”€â”€ test_v1_auth_responses.py       # è®¤è¯æ¨¡å—APIå“åº”æµ‹è¯• (14ä¸ªæµ‹è¯•)
â”‚   â”œâ”€â”€ test_v1_cases_responses.py      # æ¡ˆä¾‹æ¨¡å—APIå“åº”æµ‹è¯• (17ä¸ªæµ‹è¯•)  
â”‚   â”œâ”€â”€ test_v1_knowledge_responses.py  # çŸ¥è¯†åº“æ¨¡å—APIå“åº”æµ‹è¯• (19ä¸ªæµ‹è¯•)
â”‚   â”œâ”€â”€ test_v1_system_responses.py     # ç³»ç»Ÿæ¨¡å—APIå“åº”æµ‹è¯• (19ä¸ªæµ‹è¯•)
â”‚   â”œâ”€â”€ test_v1_development_responses.py # å¼€å‘å·¥å…·æ¨¡å—APIå“åº”æµ‹è¯• (20ä¸ªæµ‹è¯•)
â”‚   â”œâ”€â”€ test_response_consistency.py    # å“åº”ä¸€è‡´æ€§æµ‹è¯• (15ä¸ªæµ‹è¯•)
â”‚   â”œâ”€â”€ test_v1_attachment_filter.py    # é™„ä»¶ç±»å‹è¿‡æ»¤æµ‹è¯• (12ä¸ªæµ‹è¯•)
â”‚   â””â”€â”€ README.md                       # v1æµ‹è¯•è¯´æ˜
â”œâ”€â”€ suites/                              # æµ‹è¯•å¥—ä»¶
â”‚   â”œâ”€â”€ test_suite.py                   # ä¸»è¦æµ‹è¯•å¥—ä»¶è¿è¡Œå™¨
â”‚   â”œâ”€â”€ test_suite_runner.py            # é€šç”¨æµ‹è¯•å¥—ä»¶è¿è¡Œå™¨
â”‚   â”œâ”€â”€ test_deprecated_features.py     # å·²åºŸå¼ƒåŠŸèƒ½æµ‹è¯•å¥—ä»¶
â”‚   â”œâ”€â”€ test_new_features_suite.py      # é‡æ„åçš„åŠŸèƒ½æµ‹è¯•å¥—ä»¶
â”‚   â””â”€â”€ README.md                       # å¥—ä»¶è¯´æ˜
â””â”€â”€ README.md                           # æœ¬æ–‡æ¡£

æ€»è®¡ï¼š116ä¸ªAPIå“åº”æµ‹è¯•ç”¨ä¾‹
```

## å¿«é€Ÿå¼€å§‹

### 1. è¿è¡Œæ‰€æœ‰APIå“åº”æµ‹è¯•

```bash
# ä½¿ç”¨ä¾¿æ·è„šæœ¬
python scripts/development/run_api_tests.py

# æˆ–ä½¿ç”¨pytestç›´æ¥è¿è¡Œ
pytest tests/api/ -v
```

### 2. è¿è¡Œç‰¹å®šæ¨¡å—æµ‹è¯•

```bash
# è®¤è¯æ¨¡å—
python scripts/development/run_api_tests.py auth

# æ¡ˆä¾‹æ¨¡å—  
python scripts/development/run_api_tests.py cases

# çŸ¥è¯†åº“æ¨¡å—
python scripts/development/run_api_tests.py knowledge

# ç³»ç»Ÿæ¨¡å—
python scripts/development/run_api_tests.py system

# å¼€å‘å·¥å…·æ¨¡å—
python scripts/development/run_api_tests.py development

# å“åº”ä¸€è‡´æ€§
python scripts/development/run_api_tests.py consistency
```

### 3. ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š

```bash
python scripts/development/run_api_tests.py --coverage
```

## æµ‹è¯•å†…å®¹

### è®¤è¯æ¨¡å— (auth)
- âœ… ç™»å½•/ç™»å‡ºå“åº”æ ¼å¼éªŒè¯
- âœ… ç”¨æˆ·ä¿¡æ¯è·å–å“åº”éªŒè¯
- âœ… ä»¤ç‰Œåˆ·æ–°å“åº”éªŒè¯
- âœ… é”™è¯¯å“åº”æ ¼å¼ä¸€è‡´æ€§
- âœ… JWTä»¤ç‰Œæ ¼å¼éªŒè¯

### æ¡ˆä¾‹æ¨¡å— (cases)
- âœ… CRUDæ“ä½œå“åº”æ ¼å¼éªŒè¯
- âœ… æ¡ˆä¾‹äº¤äº’å“åº”éªŒè¯
- âœ… æœç´¢ç»“æœå“åº”éªŒè¯
- âœ… åˆ†é¡µæ•°æ®æ ¼å¼éªŒè¯
- âœ… æ‰¹é‡æ“ä½œå“åº”éªŒè¯

### çŸ¥è¯†åº“æ¨¡å— (knowledge)
- âœ… æ–‡æ¡£ä¸Šä¼ å“åº”éªŒè¯
- âœ… æ–‡æ¡£æœç´¢å“åº”éªŒè¯
- âœ… è¯­ä¹‰æœç´¢å“åº”éªŒè¯
- âœ… æ–‡æ¡£è§£æçŠ¶æ€å“åº”éªŒè¯
- âœ… åµŒå…¥å‘é‡æ“ä½œå“åº”éªŒè¯

### ç³»ç»Ÿæ¨¡å— (system)
- âœ… ç³»ç»ŸçŠ¶æ€å“åº”éªŒè¯
- âœ… å¥åº·æ£€æŸ¥å“åº”éªŒè¯
- âœ… ç³»ç»ŸæŒ‡æ ‡å“åº”éªŒè¯
- âœ… é…ç½®ç®¡ç†å“åº”éªŒè¯
- âœ… æ—¥å¿—å’Œç›‘æ§å“åº”éªŒè¯

### å¼€å‘å·¥å…·æ¨¡å— (development)
- âœ… APIæ–‡æ¡£å“åº”éªŒè¯
- âœ… è°ƒè¯•ä¿¡æ¯å“åº”éªŒè¯
- âœ… æ€§èƒ½æµ‹è¯•å“åº”éªŒè¯
- âœ… ä»£ç è¦†ç›–ç‡å“åº”éªŒè¯
- âœ… æµ‹è¯•è¿è¡Œå™¨å“åº”éªŒè¯

### å“åº”ä¸€è‡´æ€§ (consistency)
- âœ… æˆåŠŸå“åº”æ ¼å¼ç»Ÿä¸€æ€§
- âœ… é”™è¯¯å“åº”æ ¼å¼ç»Ÿä¸€æ€§
- âœ… HTTPçŠ¶æ€ç ä¸€è‡´æ€§
- âœ… åˆ†é¡µæ ¼å¼æ ‡å‡†åŒ–
- âœ… æ—¶é—´æˆ³æ ¼å¼ç»Ÿä¸€æ€§
- âœ… å›½é™…åŒ–æ¶ˆæ¯ä¸€è‡´æ€§

## å“åº”æ ¼å¼æ ‡å‡†

### æˆåŠŸå“åº”æ ¼å¼
```json
{
    "code": 200,
    "status": "success",
    "data": {
        // å…·ä½“æ•°æ®
    }
}
```

### é”™è¯¯å“åº”æ ¼å¼
```json
{
    "code": 400,
    "status": "error", 
    "error": {
        "type": "ERROR_TYPE",
        "message": "é”™è¯¯æè¿°"
    }
}
```

### åˆ†é¡µå“åº”æ ¼å¼
```json
{
    "code": 200,
    "status": "success",
    "data": {
        "items": [...],
        "pagination": {
            "page": 1,
            "per_page": 20,
            "total": 100,
            "pages": 5
        }
    }
}
```

## æµ‹è¯•é…ç½®

### ç¯å¢ƒè¦æ±‚
- Python 3.9+
- Flaskåº”ç”¨å·²é…ç½®
- æµ‹è¯•æ•°æ®åº“å·²è®¾ç½®
- RedisæœåŠ¡è¿è¡Œä¸­

### æµ‹è¯•æ ‡è®°
- `@pytest.mark.api_response` - APIå“åº”æµ‹è¯•æ ‡è®°
- `@pytest.mark.auth` - è®¤è¯ç›¸å…³æµ‹è¯•
- `@pytest.mark.cases` - æ¡ˆä¾‹ç›¸å…³æµ‹è¯•
- `@pytest.mark.knowledge` - çŸ¥è¯†åº“ç›¸å…³æµ‹è¯•
- `@pytest.mark.system` - ç³»ç»Ÿç›¸å…³æµ‹è¯•
- `@pytest.mark.development` - å¼€å‘å·¥å…·ç›¸å…³æµ‹è¯•
- `@pytest.mark.slow` - æ…¢é€Ÿæµ‹è¯•æ ‡è®°

### è¿è¡Œç‰¹å®šæ ‡è®°çš„æµ‹è¯•
```bash
# åªè¿è¡Œè®¤è¯ç›¸å…³æµ‹è¯•
pytest -m auth

# æ’é™¤æ…¢é€Ÿæµ‹è¯•
pytest -m "not slow"

# è¿è¡Œå¤šä¸ªæ ‡è®°
pytest -m "auth or cases"
```

## é«˜çº§ç”¨æ³•

### å¹¶è¡Œæµ‹è¯•
```bash
# ä½¿ç”¨pytest-xdistå¹¶è¡Œè¿è¡Œ
pip install pytest-xdist
pytest tests/api/ -n auto
```

### è¯¦ç»†è¾“å‡º
```bash
# æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯
pytest tests/api/ -v -s

# æ˜¾ç¤ºæœ€æ…¢çš„10ä¸ªæµ‹è¯•
pytest tests/api/ --durations=10
```

### å¤±è´¥æ—¶è°ƒè¯•
```bash
# é‡åˆ°å¤±è´¥ç«‹å³åœæ­¢
pytest tests/api/ -x

# è¿›å…¥è°ƒè¯•æ¨¡å¼
pytest tests/api/ --pdb
```

## é›†æˆåˆ°CI/CD

### GitHub Actionsç¤ºä¾‹
```yaml
name: API Response Tests
on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - name: Set up Python
      uses: actions/setup-python@v2
      with:
        python-version: 3.9
    - name: Install dependencies
      run: |
        pip install -r requirements.txt
    - name: Run API tests
      run: |
        python scripts/development/run_api_tests.py --coverage
    - name: Upload coverage
      uses: codecov/codecov-action@v1
```

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **è®¤è¯å¤±è´¥**
   ```
   è§£å†³æ–¹æ¡ˆï¼šç¡®ä¿æµ‹è¯•ç”¨æˆ·å·²åˆ›å»ºä¸”å¯†ç æ­£ç¡®
   ```

2. **æ•°æ®åº“è¿æ¥å¤±è´¥**
   ```
   è§£å†³æ–¹æ¡ˆï¼šæ£€æŸ¥æµ‹è¯•æ•°æ®åº“é…ç½®å’Œè¿æ¥
   ```

3. **Redisè¿æ¥å¤±è´¥**
   ```
   è§£å†³æ–¹æ¡ˆï¼šå¯åŠ¨RedisæœåŠ¡æˆ–ä½¿ç”¨mock Redis
   ```

4. **æ¨¡å—å¯¼å…¥é”™è¯¯**
   ```
   è§£å†³æ–¹æ¡ˆï¼šç¡®ä¿Pythonè·¯å¾„æ­£ç¡®é…ç½®
   ```

### æ—¥å¿—è°ƒè¯•
```bash
# å¯ç”¨è¯¦ç»†æ—¥å¿—
pytest tests/api/ --log-cli-level=DEBUG
```

## è´¡çŒ®æŒ‡å—

### æ·»åŠ æ–°çš„æµ‹è¯•

1. åœ¨ç›¸åº”çš„æµ‹è¯•æ–‡ä»¶ä¸­æ·»åŠ æµ‹è¯•æ–¹æ³•
2. éµå¾ªç°æœ‰çš„å‘½åçº¦å®šï¼š`test_<åŠŸèƒ½>_response`
3. ç¡®ä¿æµ‹è¯•åŒ…å«å®Œæ•´çš„å“åº”éªŒè¯
4. æ·»åŠ é€‚å½“çš„æ–‡æ¡£å­—ç¬¦ä¸²

### æµ‹è¯•æœ€ä½³å®è·µ

1. **å“åº”ç»“æ„éªŒè¯**ï¼šå§‹ç»ˆéªŒè¯å“åº”çš„åŸºæœ¬ç»“æ„
2. **çŠ¶æ€ç æ£€æŸ¥**ï¼šéªŒè¯HTTPçŠ¶æ€ç ä¸å“åº”ä½“codeå­—æ®µä¸€è‡´
3. **æ•°æ®ç±»å‹éªŒè¯**ï¼šæ£€æŸ¥è¿”å›æ•°æ®çš„ç±»å‹æ­£ç¡®æ€§
4. **è¾¹ç•Œæ¡ä»¶æµ‹è¯•**ï¼šæµ‹è¯•ç©ºæ•°æ®ã€å¤§æ•°æ®ç­‰è¾¹ç•Œæƒ…å†µ
5. **é”™è¯¯å¤„ç†æµ‹è¯•**ï¼šéªŒè¯å„ç§é”™è¯¯åœºæ™¯çš„å“åº”æ ¼å¼

## æŠ¥å‘Šå’Œç›‘æ§

### è¦†ç›–ç‡æŠ¥å‘Š
æµ‹è¯•å®Œæˆåä¼šç”ŸæˆHTMLè¦†ç›–ç‡æŠ¥å‘Šï¼š
- è·¯å¾„ï¼š`htmlcov/api_responses/index.html`
- å¯åœ¨æµè§ˆå™¨ä¸­æŸ¥çœ‹è¯¦ç»†çš„ä»£ç è¦†ç›–æƒ…å†µ

### æ€§èƒ½ç›‘æ§
- å“åº”æ—¶é—´ç›‘æ§
- å†…å­˜ä½¿ç”¨ç›‘æ§  
- å¹¶å‘è¯·æ±‚å¤„ç†èƒ½åŠ›æµ‹è¯•
