# 性能基准测试

本目录包含系统性能基准测试，用于验证性能优化效果和系统稳定性。

## 测试分类

### 1. 基准性能测试 (`test_performance_benchmarks.py`)

#### LLM服务性能测试
- **测试内容**: LLM服务响应时间基准
- **性能指标**: 
  - 平均响应时间 < 5秒
  - 最大响应时间 < 10秒
  - 单次调用 < 10秒

#### 缓存性能测试
- **测试内容**: Redis缓存性能提升效果
- **性能指标**:
  - 缓存命中响应时间 < 原始时间的20%
  - 后续缓存调用 < 0.1秒
  - 性能提升倍数 > 5倍

#### 并发性能测试
- **测试内容**: 多线程并发请求处理
- **性能指标**:
  - 成功率 ≥ 70%
  - 总耗时 < 30秒
  - 平均响应时间 < 8秒

#### 检索服务性能测试
- **测试内容**: 知识检索响应时间
- **性能指标**:
  - 单次检索 < 3秒
  - 平均检索时间 < 2秒

#### 内存稳定性测试
- **测试内容**: 长期运行内存使用监控
- **性能指标**:
  - 内存增长 < 100MB

### 2. 压力测试 (`TestStressTests`)

#### 高负载模拟测试
- **测试内容**: 模拟高并发访问场景
- **性能指标**:
  - 成功率 ≥ 80%
  - 总耗时 < 60秒

## 运行测试

### 运行所有基准测试
```bash
pytest tests/benchmarks/ -m benchmark -v
```

### 运行特定测试类
```bash
# 性能基准测试
pytest tests/benchmarks/test_performance_benchmarks.py::TestPerformanceBenchmarks -v

# 压力测试
pytest tests/benchmarks/test_performance_benchmarks.py::TestStressTests -v
```

### 运行慢速测试（包含压力测试）
```bash
pytest tests/benchmarks/ -m "benchmark and slow" -v
```

### 生成性能报告
```bash
pytest tests/benchmarks/ -m benchmark --html=reports/performance_report.html
```

## 测试环境要求

### 系统资源
- **内存**: 建议 ≥ 4GB 可用内存
- **CPU**: 建议 ≥ 4核处理器
- **存储**: 建议 ≥ 2GB 可用空间

### 依赖服务
- **Redis**: 缓存服务（必需）
- **数据库**: PostgreSQL/SQLite（必需）
- **AI服务**: LLM服务配置（可选，有模拟备用）

### 网络环境
- 如果使用真实AI服务，需要稳定的网络连接
- 本地测试可以使用模拟服务

## 性能基准参考

### 响应时间基准
| 服务类型 | 目标响应时间 | 可接受范围 |
|---------|-------------|------------|
| LLM分析 | < 3秒 | < 5秒 |
| 缓存查询 | < 0.1秒 | < 0.2秒 |
| 知识检索 | < 1秒 | < 2秒 |
| 数据库查询 | < 0.5秒 | < 1秒 |

### 并发性能基准
| 并发数 | 成功率目标 | 平均响应时间 |
|-------|------------|-------------|
| 5并发 | ≥ 90% | < 5秒 |
| 10并发 | ≥ 80% | < 8秒 |
| 20并发 | ≥ 70% | < 12秒 |

### 缓存性能基准
| 指标 | 目标值 |
|------|--------|
| 命中率 | ≥ 80% |
| 性能提升 | ≥ 5倍 |
| 缓存响应时间 | < 50ms |

## 故障排查

### 常见问题

#### 1. Redis连接失败
```
错误: Redis connection failed
解决: 检查Redis服务状态，确认连接配置
```

#### 2. 测试超时
```
错误: Test timeout after 30s
解决: 检查网络连接，考虑增加超时时间
```

#### 3. 内存不足
```
错误: MemoryError during stress test
解决: 增加可用内存或减少并发数
```

#### 4. 数据库连接池耗尽
```
错误: Database connection pool exhausted
解决: 增加连接池大小或优化查询
```

### 性能调优建议

#### LLM服务优化
1. **缓存策略**: 合理设置缓存过期时间
2. **连接池**: 配置适当的连接池大小
3. **超时设置**: 根据网络情况调整超时时间
4. **负载均衡**: 考虑使用多个LLM服务端点

#### 缓存优化
1. **内存配置**: 为Redis分配足够内存
2. **过期策略**: 设置合理的缓存过期策略
3. **数据压缩**: 对大数据启用压缩
4. **缓存预热**: 预加载常用数据

#### 数据库优化
1. **索引优化**: 为常用查询添加索引
2. **连接池**: 配置合适的连接池参数
3. **查询优化**: 避免N+1查询问题
4. **读写分离**: 考虑主从分离架构

## 持续监控

### 性能指标监控
- 定期运行基准测试
- 监控关键性能指标变化趋势
- 设置性能阈值告警

### 自动化测试
- 集成到CI/CD流程
- 性能回归检测
- 自动生成性能报告

### 性能分析工具
- 使用内置的`monitoring.py`模块
- 集成第三方APM工具
- 定期生成性能分析报告
